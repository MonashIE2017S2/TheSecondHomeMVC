@{
    ViewBag.Title = "ChatHub";
}


<style>
    .c-list {
        padding: 0px;
        min-height: 44px;
    }

    .title {
        display: inline-block;
        font-size: 1.7em;
        font-weight: bold;
        padding: 5px 15px;
    }

    ul.c-controls {
        list-style: none;
        margin: 0px;
        min-height: 44px;
    }

    ul.c-controls li {
        margin-top: 8px;
        float: left;
    }

    ul.c-controls li a {
        font-size: 1.7em;
        padding: 11px 10px 6px;
    }

    ul.c-controls li a i {
        min-width: 24px;
        text-align: center;
    }

    ul.c-controls li a:hover {
        background-color: rgba(51, 51, 51, 0.2);
    }

    .c-toggle {
        font-size: 1.7em;
    }

    .name {
        font-size: 1.7em;
        font-weight: 700;
    }

    .c-info {
        padding: 5px 10px;
        font-size: 1.25em;
    }
</style>

@*<h2>Chat</h2>
<div class="container">
    <input type="text" id="message" />
    <input type="button" id="sendmessage" value="Send" />
    <input type="hidden" id="displayname" />
    <ul id="discussion"></ul>
</div>
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message) {
                // Add the message to the page.
                $('#discussion').append('<li><strong>' + htmlEncode(name)
                    + '</strong>: ' + htmlEncode(message) + '</li>');
            };
            // Get the user name and store it to prepend to messages.
            $('#displayname').val(prompt('Enter your name:', ''));
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send($('#displayname').val(), $('#message').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}*@

@section scripts {
    <script src="~/Scripts/jquery-3.2.1.js"></script>
    <script src="~/Scripts/bootbox.min.js"></script>
    <script src="~/Scripts/jquery.signalR-2.2.2.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>
        var chat = $.connection.chatHub;
        var name = null;

        //Promote a window for the user to input NickName
        $(function() {
            name = prompt("Please input your Pseudonym", "TeacherA");
        });

        //After the SignalR set up, what need to do
        $.connection.hub.start().done(function() {

            //Make the server know when new user come
            chat.server.userConnected(name);

            //Send Button
            $('#btnSend').click(function() {
                send();
            });
            //when Enter button click
            $('#txtMsg').keydown(function(e) {
                if (e.which == 13) {
                    send();
                }
            });

            //Select one user
            $(document).on("click",
                "#lstUser li",
                function() {
                    var name = $(this).html();
                    var id = $(this).attr('id');

                    $('#lblTalkToWho').html(name);
                    $('#lblTalkToWhoId').html(id);
                });
        });

        //Display Usage
        chat.client.show = function(message) {
            $('#chatRoom').append('<li>' + message + '</li>');
        };

        //Display User List
        chat.client.getList = function(users) {
            var li = "<li id=all>Public Channel</li>";
            $.each(users,
                function(i, user) {
                    li += '<li id=' + user.id + ' >' + user.name + '</li>'
                });
            $('#lstUser').html(li);
        };

        //User Leave
        chat.client.removeList = function(id) {
            $('#' + id).remove();
        };

        function checkkeywords(sentence) {
            var flag = false;
            var keywords = ['VIC', 'vic', 'NSW', 'nsw', 'TAS', 'tas', 'ACT', 'act', 'SA', 'sa', 'WA', 'wa'];
            for (var i = 0; i < keywords.length; i++) {
                var check = sentence.search(keywords[i]);
                if (check >= 0) {
                    flag = true;
                }
            }
            return flag;
        }

        console.log(checkkeywords("Hello, this is"));

        //Send message to the server
        function send() {
            var id = $('#lblTalkToWhoId').text();
            var message = $('#txtMsg').val();
            if (id == "all") {
                if (checkkeywords(message.toLowerCase())) {
                    bootbox.alert("dont input personal address");
                } else {
                    chat.server.send($('#txtMsg').val());
                }
            } else {
                chat.server.sendOne(id, $('#txtMsg').val());
            }
            $('#txtMsg').val('');
        }

    </script>
}
<div class="container">
    <div class="row clearfix">
        <br>
        <div class="row">
            <div class="col-xs-6 col-sm-offset-1 col-sm-5">
                <div class="panel panel-warning">
                    <div class="panel-heading">Chat Room</div>
                    <div class="panel-body" style="height: 350px; word-break: break-all; overflow-y: scroll;">
                        <ul id="chatRoom"></ul>
                    </div>
                </div>
                <div class="container">
                    Send To:
                    <label id="lblTalkToWho">Public Channel</label>
                    <label id="lblTalkToWhoId" hidden>all</label>
                    <input id="txtMsg" type="text" />
                    <input type="button" id="btnSend" value="Send" class="btn btn-warning" />
                </div>
            </div>
            <div class="col-xs-6 col-sm-offset-0 col-sm-3">
                <div class="panel panel-warning">
                    <div class="panel-heading">Contact List</div>
                    <div class="panel-body" style="height: 410px; word-break: break-all; overflow-y: scroll;">
                        <ul class="list-group" id="contact-list">
                            <li class="list-group-item">
                                <ul id="lstUser"></ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <br />
    </div>
</div>